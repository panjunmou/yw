<!DOCTYPE html>
<html lang="zh_CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bootdo - 文件管理器</title>
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="stylesheet" href="/css/bootstrap.min.css?v=3.3.6">
    <link rel="stylesheet" href="/css/plugins/toastr/toastr.min.css">
    <link rel="stylesheet" href="/css/plugins/bootstrap-treeview/bootstrap-treeview.css">
    <link rel="stylesheet" href="/css/font-awesome.css?v=4.4.0">
    <link rel="stylesheet" href="/css/animate.css">
    <link rel="stylesheet" href="/css/style.css?v=4.1.0">
    <link rel="stylesheet" href="/css/attactment/attactment.css">
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-sm-3">
            <div class="left-content">
                <!--<input onkeyup="searchOrgTree(this)" type="text" class="form-control"
                       placeholder="please enter org name"/>-->
                <div id="orgTree" style="height: 470px;overflow-y :scroll;"></div>
            </div>
        </div>
        <div class="col-sm-9">
            <div id="right-content" class="right-content">
                <div class="zuijinTop">
                    <div style="margin-top: 12px">
                        <button type="button" class="btn btn-info" onclick="newDir()">
                            <i class="glyphicon glyphicon-plus" aria-hidden="true"></i> 新建文件夹
                        </button>&nbsp;&nbsp;
                        <button type="button" class="btn btn-primary" onclick="upload()">
                            <i class="glyphicon glyphicon-upload" aria-hidden="true"></i> 上传文件
                        </button>&nbsp;&nbsp;
                        <button type="button" class="btn btn-info" onclick="">
                            <i class="glyphicon glyphicon-download" aria-hidden="true"></i> 下载
                        </button>&nbsp;&nbsp;
                       <!-- <button type="button" class="btn btn-success" onclick="">
                            <i class="glyphicon glyphicon-move" aria-hidden="true"></i> 移动到
                        </button>&nbsp;&nbsp;
                        <button type="button" class="btn btn-warning" onclick="">
                            <i class="glyphicon glyphicon-edit" aria-hidden="true"></i> 重命名
                        </button>&nbsp;&nbsp;-->
                        <button type="button" class="btn btn-danger" onclick="">
                            <i class="glyphicon glyphicon-remove" aria-hidden="true"></i> 删除
                        </button>&nbsp;&nbsp;
                        <button type="button" class="btn btn-warning" onclick="roleSet()">
                            <i class="glyphicon glyphicon-edit" aria-hidden="true"></i> 权限设置
                        </button>
                    </div>
                </div>
                <div class="zuijinTitle cl">
                    <img src="/img/attactment/select.png" data-all="no" class="z allIcon allSelect" alt="">
                    <!--<div class="z the">我的文档</div>-->
                    <!--<div class="z the">人事</div>-->
                    <div class="z">
                        <ol class="breadcrumb" id="breadcrumbNav">
                            <!--<li><a href="#">Home</a></li>-->
                            <!--<li><a href="#">Library</a></li>-->
                            <!--<li class="active">Data</li>-->
                        </ol>
                    </div>
                </div>
                <div class="content cl" id="fileDiv"
                     style="top:150px;height:380px;padding-left:2%;overflow-y:auto;pisition:relative;">
                    <!--<div class="box template" data-show="no">
                        <img src="/img/attactment/wenjian.png" class="myIcon" alt="">
                        <div>
                            <p>合同管理合同管理合同管理合同管理</p>
                            <input type="text" class="none">
                        </div>
                        <img src="/img/attactment/select.png" class="select" alt="">
                    </div>-->
                </div>
            </div>
        </div>
    </div>
</div>
<form id="AttSearchForm">
    <input type="hidden" name="keyWords" id="orgKeyWord"/>
</form>
<!-- 全局js -->
<script type="text/javascript" src="/js/jquery.min.js?v=2.1.4"></script>
<script type="text/javascript" src="/js/bootstrap.min.js?v=3.3.6"></script>
<script type="text/javascript" src="/js/jquery.blockUI.js"></script>
<script type="text/javascript" src="/js/ajaxExt.js"></script>
<script type="text/javascript" src="/js/plugins/toastr/toastr.min.js"></script>
<script type="text/javascript" src="/js/plugins/layer/layer.js"></script>
<script type="text/javascript" src="/js/plugins/bootstrap-treeview/bootstrap-treeview.js"></script>
<script type="text/javascript" th:inline="javascript">
    toastr.options = {
        closeButton: true,
        positionClass: "toast-center-center",
        timeOut: "1300"
    };
    // var parentId = [[${parentId}]];
    var parentId;
    $(function () {
        //组织机构树
        initOrgTree();

        loadFile();

        $(".allIcon").click(function () {
            if ($(this).attr("data-all") == "yes") {
                $(this).attr("src", "/img/attactment/select.png");
                $(".select").attr("src", "/img/attactment/select.png");
                $(this).attr("data-all", "no");
                $(".template").attr("data-show", "no");
                $(".template").removeClass("box2H");
            } else {
                $(this).attr("src", "/img/attactment/selectC.png");
                $(".template").attr("data-show", "yes");
                $(this).attr("data-all", "yes");
                $(".template").addClass("box2H");
                $(".select").attr("src", "/img/attactment/selectC.png");
            }
        });

    });

    function loadFile(pId) {
        if(pId == undefined || pId == null || pId == ''){
            pId = "0";
        }
        parentId = pId;
        $.ajaxExt({
            url: 'attactment/listFile',
            type: 'GET',
            data: {
                parentId: pId
            },
            success: function (result) {
                loadNavList(pId);
                if (result.result == 1) {
                    var attachmentList = result.data;
                    $.each(attachmentList, function (i, attachment) {
                        var fileStr = "";
                        if (attachment.isDirectory == 1) {
                            fileStr +=
                                '<div class="box template" data-show="no" id="' + attachment.id + '" isDirectory="1">\n';
                            fileStr +=
                                '    <img src="/img/attactment/wenjian.png" class="myIcon" alt="">\n';
                        } else {
                            var picStr = getPic(attachment.fileExt);
                            fileStr +=
                                '<div class="box2 template" data-show="no" id="' + attachment.id + '" isDirectory="0">\n';
                            fileStr +=
                                '    <img src="/img/attactment/' + picStr + '" class="myIcon" alt="">\n';
                        }
                        fileStr +=
                            '<div>\n' +
                            '<p>' + attachment.originalFullName + '</p>\n' +
                            '</div>\n' +
                            '<img src="/img/attactment/select.png" class="select" alt="">\n' +
                            '</div>';
                        $("#fileDiv").append(fileStr);
                    });
                    bindMyClick();
                } else {
                    toastr.error(result.message);
                }
            }
        });
    }

    function loadNavList(pId) {
        $.ajaxExt({
            url: 'attactment/getNavList',
            type: 'GET',
            data: {
                parentId: pId
            },
            success: function (result) {
                $("#breadcrumbNav li").remove();
                var attachmentList = result.data;
                $.each(attachmentList, function (i, attachment) {
                    if (parseInt(i + 1) == attachmentList.length) {
                        $("#breadcrumbNav").append('<li>' + attachment.originalFileName + '</li>');
                    } else {
                        $("#breadcrumbNav").append('<li><a href="javascript:void(0)" id="' + attachment.id + '">' + attachment.originalFileName + '</a></li>');
                    }
                });
                $("#breadcrumbNav li:last").addClass("active");
                $("#breadcrumbNav li a").on("click", function () {
                    var parentId = $(this).attr("id");
                    reloadFile(parentId);
                });
            }
        });
    }

    function getPic(fileExt) {
        switch (fileExt.toLowerCase()) {
            case 'zip':
            case 'tar':
            case 'rar':
            case '7z':
                return 'file_zip.png';
            case 'txt':
                return 'file_txt.png';
            case 'sql':
            case 'java':
                return 'file_code.png';
            case 'html':
            case 'htm':
                return 'file_txt.png';
            case 'doc':
            case 'docx':
                return 'file_word.png';
            case 'xlsx':
            case 'xls':
                return 'file_excel.png';
            case 'jpg':
            case 'gif':
            case 'png':
                return 'file_img.png';
            case 'pdf':
                return 'file_pdf.png';
            case 'ppt':
            case 'pptx':
                return 'file_ppt.png';
            case 'wmv':
            case 'asf':
            case 'asx':
            case 'rm':
            case 'rmb':
            case 'mp4':
            case '3gp':
            case 'mov':
            case 'm4v':
            case 'avi':
            case 'mkv':
            case 'flv':
                return 'file_video.png';
            case 'mp3':
                return 'file_music.png';
            default:
                return 'file_blank.png';
        }
    }

    function bindMyClick() {
        $(".content .template").each(function () {
            $(this).click(function () {
                if ($(this).attr("data-show") == "yes") {
                    $(this).removeClass(".box2C");
                    $(this).removeClass(".box2H");
                    $(this).find(".select").attr("src", "/img/attactment/select.png");
                    $(this).attr("data-show", "no");
                } else {
                    $(this).addClass(".box2C");
                    $(this).addClass(".box2H");
                    $(this).find(".select").attr("src", "/img/attactment/selectC.png");
                    $(this).attr("data-show", "yes");
                    $(this).find(".select").show();
                }
            });
            $(this).dblclick(function () {
                var isDirectory = $(this).attr("isDirectory");
                if (isDirectory == '1') {
                    var parentId = $(this).attr("id");
                    reloadFile(parentId);
                }
            });
        });
    }

    function initOrgTree() {
        $.ajaxExt({
            url: "attactment/getAttTree",
            type: 'GET',
            data: {
                containsFile: '0'//不包含文件
            },
            success: function (data) {
                $('#orgTree').treeview(
                    {
                        data: data.data,
                        loadingIcon: "glyphicon glyphicon-refresh",//懒加载过程中显示的沙漏字符图标
                        lazyLoad: loadData,
                        onNodeSelected: function (event, data) {
                            reloadFile(data.id);
                        }
                    }
                );
                $('#orgTree').treeview('search', [$("#orgKeyWord").val(), {
                    ignoreCase: true,    // case insensitive
                    exactMatch: false,   // like or equals
                    revealResults: true // reveal matching nodes
                }]);
            }
        });
    }

    function loadData(node, func) {
        //这个技巧真高，即能得到节点数据，又能把节点下级的数据通过函数发回去
        $.ajaxExt({
            url: "attactment/getAttByParentId",
            data: {
                containsFile: '0',//不包含文件
                parentId: node.id
            },
            success: function (data) {
                //把新的下级节点数据发回到后端，这样明显优雅很多
                func(data.data);
            }
        });
    }

    function upload() {
        layer.open({
            type: 2,
            title: '文件上传',
            maxmin: false,
            shadeClose: false, // 点击遮罩关闭层
            closeBtn: 0,// 不显示右上角的关闭
            area: ['660px', '418px'],
            content: 'attactment/uploadPage?parentId=' + parentId
        });
    }

    //权限设置
    function roleSet() {
        var checkedDiv = $("#fileDiv div[data-show='yes']");
        if(checkedDiv.length == 0 || checkedDiv.length > 1){
            layer.alert(
                '请只选择一个文件',
                {
                    title:'提示',
                    time: 0,//不自动关闭,
                    icon: 2
                }
            );
            return;
        }
        var id = checkedDiv.attr("id");
        layer.open({
            type: 2,
            title: '权限设置',
            maxmin: true,
            shadeClose: false, // 点击遮罩关闭层
            closeBtn: 1,// 不显示右上角的关闭
            area: ['660px', '418px'],
            content: 'attachmentRole?id=' + id
        });
    }

    function newDir() {
    }

    function reloadFile(pId) {
        $(".template").remove();
        loadFile(pId);
    }
</script>

</body>
</html>
